<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
                 <link rel="shortcut icon" href="/tnf/resource/favicon.ico" type="image/x-icon"> 
		<title>
			NetBSD Blog
		</title>
                <link rel="stylesheet" type="text/css" href='/tnf/resource/global.css' />
		<link rel="stylesheet" type="text/css" href='/tnf/page/custom.css' />
	</head>
	<body>
		
			        
            <link rel="alternate" type="application/atom+xml" title="Recent Entries (Atom)"  href="http://blog.netbsd.org/tnf/feed/entries/atom" />
    <link rel="alternate" type="application/rss+xml"  title="Recent Entries (RSS)"   href="http://blog.netbsd.org/tnf/feed/entries/rss" />
    <link rel="alternate" type="application/atom+xml" title="Recent Comments (Atom)" href="http://blog.netbsd.org/tnf/feed/comments/atom" />
    <link rel="alternate" type="application/rss+xml"  title="Recent Comments (RSS)"  href="http://blog.netbsd.org/tnf/feed/comments/rss" />

    
                <link rel="search"
            title="OpenSearch Descriptor for weblog NetBSD Blog"
            type="application/opensearchdescription+xml"
            href="http://blog.netbsd.org/roller-services/opensearch/tnf" />
    		
		<div id="header">
			<div class="topNavigation">
				<span>&raquo;</span> <a href="http://www.NetBSD.org/docs/guide/en/">The Guide</a> | <a href="http://man.NetBSD.org">Manual pages</a> | <a href="http://www.NetBSD.org/mailinglists/">Mailing lists</a> and <a href="http://mail-index.NetBSD.org/">Archives</a> | <a href="http://cvsweb.NetBSD.org/">CVS repository</a> | <a href="http://www.NetBSD.org/cgi-bin/sendpr.cgi?gndb=netbsd">Report</a> or <a href="http://gnats.NetBSD.org/">query</a> a bug | <a href="http://www.NetBSD.org/docs/software/packages.html">Software Packages</a>
			</div>
			<div class="centralHeader">
				<a href="/"><img src="/tnf/resource/NetBSD-headerlogo.png" alt="[NetBSD Logo]" width="506" height="90" /></a>
				<div class="headerTools">
<BR>
					<div id="headerSearch">
						<form method="get" action="/tnf/search">
							<input class="whiteOnBlack" type="text" name="q" onfocus="if(this.value==this.defaultValue ) this.value='';" size="12" maxlength="255" value="Search" /> <input type="submit" value="Search" />
						</form>
					</div>
				</div>
			</div>
			<div class="navBar">
				<a href="http://blog.netbsd.org/tnf/" title="Home">Home</a>&nbsp;|&nbsp;
                                <img src="/tnf/resource/feed-icon-14x14.png" border=0 align="absmiddle"><a href="http://blog.netbsd.org/tnf/feed/entries/atom">RSS</a>&nbsp;|&nbsp;
 <a href="http://blog.netbsd.org/tnf/category/General" title="General">General</a>&nbsp;|&nbsp;  <a href="http://blog.netbsd.org/tnf/category/Release+engineering" title="Blog about NetBSD release engineering.">Release engineering</a>&nbsp;|&nbsp;  <a href="http://blog.netbsd.org/tnf/category/Networking" title="">Networking</a>&nbsp;|&nbsp;  <a href="http://blog.netbsd.org/tnf/category/Development" title="About NetBSD development.">Development</a>&nbsp;|&nbsp;  <a href="http://blog.netbsd.org/tnf/category/Events" title="Upcoming and past events.">Events</a>&nbsp;|&nbsp;  <a href="http://blog.netbsd.org/tnf/category/The+NetBSD+Foundation" title="TNF articles.">The NetBSD Foundation</a>&nbsp;|&nbsp;  <a href="http://blog.netbsd.org/tnf/category/Packages" title="The most portable package software in the world.">Packages</a>&nbsp;|&nbsp;  <a href="http://blog.netbsd.org/tnf/category/Security" title="Security advisories and security related information.">Security</a>&nbsp;|&nbsp;  <a href="http://blog.netbsd.org/tnf/category/Ports" title="Port specific news">Ports</a>&nbsp;|&nbsp; 
      <a href="/roller-ui/login-redirect.rol"><span>Login</span></a>
  			</div>
		</div>
		<div id="content">
			<div class="rowOfBoxes">
				<div class="quarter noBorderOnLeft borderOnRight sideBarLeft">

                                                <h3>Bookmarks</h3>
                                                                                                <ul class="rFolder">
                    <li class="rFolderItem">
                                <a href="http://www.NetBSD.org/"
               title="NetBSD is a free, secure, and highly portable Unix-like Open Source operating system available for many platforms, from large-scale server systems to powerful desktop systems to handheld and embedded devices."
               class="rBookmark0">The NetBSD Project</a>
                </li>
            <li class="rFolderItem">
                                <a href="http://wiki.netbsd.org/"
               title="The NetBSD Wiki is a collaborative writing project to build useful resources for NetBSD users."
               class="rBookmark0">NetBSD Wiki</a>
                </li>
                    </ul>
	
						<h3>Feeds</h3>
						    <ul class="rFeeds">
    <li><a href="http://blog.netbsd.org/tnf/feed/entries/atom">All</a></li>
                <li><a href="http://blog.netbsd.org/tnf/feed/entries/atom?cat=%2FGeneral">/General</a></li>
            <li><a href="http://blog.netbsd.org/tnf/feed/entries/atom?cat=%2FRelease+engineering">/Release engineering</a></li>
            <li><a href="http://blog.netbsd.org/tnf/feed/entries/atom?cat=%2FNetworking">/Networking</a></li>
            <li><a href="http://blog.netbsd.org/tnf/feed/entries/atom?cat=%2FDevelopment">/Development</a></li>
            <li><a href="http://blog.netbsd.org/tnf/feed/entries/atom?cat=%2FEvents">/Events</a></li>
            <li><a href="http://blog.netbsd.org/tnf/feed/entries/atom?cat=%2FThe+NetBSD+Foundation">/The NetBSD Foundation</a></li>
            <li><a href="http://blog.netbsd.org/tnf/feed/entries/atom?cat=%2FPackages">/Packages</a></li>
            <li><a href="http://blog.netbsd.org/tnf/feed/entries/atom?cat=%2FSecurity">/Security</a></li>
            <li><a href="http://blog.netbsd.org/tnf/feed/entries/atom?cat=%2FPorts">/Ports</a></li>
        <li><a href="http://blog.netbsd.org/tnf/feed/comments/atom">Comments</a></li>
    </ul>

			</div>
			</div>
			<div class="mainContent">
				<div class="half noBorderOnLeft" style="border-left: 1px dotted #000">
							  		              <h2><a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript">Kernel Drivers Compiled to Javascript and Run in Browser</a></h2><BR>
<div class="descr">November 07, 2012 posted by <i>Antti Kantee</I></div><BR>

  <p>
The unique anykernel capability of NetBSD allows the creation of
<a href="http://www.NetBSD.org/docs/rump">rump kernels</a>, which are
partially paravirtualized kernels running on top of a high-level
hypervisor.  This technology e.g. enables running the
<b>same</b> file system driver in the monolithic kernel or as a
microkernel style server in userspace.  POSIX-compatible
systems have been more or less supported as rump kernel hypervisors for
the past 5 years.  A long-time goal has been to extend hypervisor
support further, for example to embedded systems.  This would bring the
solid driverbase of NetBSD available to such systems with only the cost of
implementing the hypervisor.
</p>

<p>
To see how far things can go, last week I started toying with the
idea of using a javascript engine as a rump kernel hypervisor.  I was
planning to compile the NetBSD kernel sources into javascript and
manually implement the hypervisor.  After some
searching for a C->javascript compiler, I found
<a href="http://emscripten.org">emscripten</a>, which translates C into
javascript via LLVM bitcode.  Not only is the compiler itself extremely
mature, but there is also extensive support for the POSIX API.  This meant that
I could not only compile the kernel drivers to javascript with emscripten, I
could also compile the existing POSIX hypervisor and have it work.
</p>

<p>
The approach of compiling kernel drivers into javascript allows
them to be directly accessed from existing javascript code.  Yes,
I did add a <tt>sys/arch/javascript</tt> into the kernel source
tree.  This contrasts the approach taken by
<a href="http://bellard.org/jslinux/">another similar experiment</a>,
where an x86 Linux is run inside a x86 machine emulator running
in a javascript engine.
</p>

<p>
I have thrown together a small proof-of-concept demo of how to build a
web service with the capability to access file system images using
kernel file system drivers compiled to javascript.  I compiled a rump
kernel with support for the FFS, tmpfs and kernfs file systems.  This
rump kernel backend is tied to a lightweight web page which passes
requests from forms to the rump kernel and displays results.  When the
javascript is run, it downloads an FFS image (<tt>rump.data</tt>),
bootstraps a rump kernel, and mounts the FFS image r/o at <tt>/ffs</tt>.
The status can be further manipulated with interactive commands.
</p>

<p>
The demo is available
<a href="http://ftp.netbsd.org/pub/NetBSD/misc/pooka/rump.js/">here</a>.
I've tested it to work with Firefox and tested it to not work
with Internet Explorer.  YMMV with other browsers.  Note,
the javascript and the FFS image together are close to 5.5MB in
size, so the page may load for a few moments over a slow link --
javascript is not exactly compact and
whitespace removal was the only size reduction technique I used.
If you're interested in comparing the generated javascript with the <a
href="http://ftp.netbsd.org/pub/NetBSD/NetBSD-current/src/sys/">C
sources</a>, you can also look at the
<a href="http://ftp.netbsd.org/pub/NetBSD/misc/pooka/rump.js/rump.jsO0.txt">unoptimized version</a> (14MB).
</p>


   [<a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comments">16 comments</a>]
 
</p>

<p>
<script type="text/javascript">
digg_url = 'http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript';
digg_title = 'Kernel Drivers Compiled to Javascript and Run in Browser';
digg_skin = 'compact';
digg_window = 'new';
</script>
<script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>

<!--
<img src="http://images.slashdot.org/favicon.ico" alt="Slashdot" border="0" height="16" width="16">
<a href="javascript:location.href='http://slashdot.org/slashdot-it.pl?op=basic&amp;url='+encodeURIComponent(http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript)">Slashdot It!</a>
-->
</p>

<p>&nbsp;</p>

    		  <div class="next-prev">
		  		                                 &laquo; <a href="http://blog.netbsd.org/tnf/entry/hydra_amiganet_asdg_lan_rover">Hydra AmigaNet /...</a> |  
                <a href="/tnf/">Main</a>
                | <a href="http://blog.netbsd.org/tnf/entry/a2000_style_rtc_driver_rewritten">A2000-style RTC...</a> &raquo;
    		  		  </div>
		  		     <br/><br/>
		     		         <a name="comments"></a>
    <div class="comments" id="comments">

            <div class="comments-head">Comments:</div>
            
    <br/>
                        <a name="comment-1352381192000" id="comment-1352381192000"></a>
            <div class="comment odd" id="comment1">

                OMG

See you at the hackathon...

                <p class="comment-details">
                Posted by
                                    <a rel="nofollow" href="http://yasep.org"><b>whygee</b></a>
                
                on November 08, 2012 at 01:26 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352381192000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352384866000" id="comment-1352384866000"></a>
            <div class="comment even" id="comment2">

                It works fine under Internet Explorer 10.

                <p class="comment-details">
                Posted by
                                    <b>xenu</b>
                
                on November 08, 2012 at 02:27 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352384866000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352391253000" id="comment-1352391253000"></a>
            <div class="comment odd" id="comment3">

                Works fine with Safari 6.0.2, OS X 10.8.2.

                <p class="comment-details">
                Posted by
                                    <b>jideel</b>
                
                on November 08, 2012 at 04:14 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352391253000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352391429000" id="comment-1352391429000"></a>
            <div class="comment even" id="comment4">

                Works great under Chrome 22!

                <p class="comment-details">
                Posted by
                                    <b>Jon</b>
                
                on November 08, 2012 at 04:17 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352391429000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352416080000" id="comment-1352416080000"></a>
            <div class="comment odd" id="comment5">

                Works in Opera 12.2

                <p class="comment-details">
                Posted by
                                    <b>vdvluc</b>
                
                on November 08, 2012 at 11:08 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352416080000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352416934000" id="comment-1352416934000"></a>
            <div class="comment even" id="comment6">

                Works with xombrero browser

                <p class="comment-details">
                Posted by
                                    <b>sjakke</b>
                
                on November 08, 2012 at 11:22 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352416934000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352429450000" id="comment-1352429450000"></a>
            <div class="comment odd" id="comment7">

                Nicely done! Works on IOS 6.1 Safari! (iPhone)

                <p class="comment-details">
                Posted by
                                    <b>Tim</b>
                
                on November 09, 2012 at 02:50 AM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352429450000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352441749000" id="comment-1352441749000"></a>
            <div class="comment even" id="comment8">

                Works fine on chrome for android

                <p class="comment-details">
                Posted by
                                    <b>sergi</b>
                
                on November 09, 2012 at 06:15 AM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352441749000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352465160000" id="comment-1352465160000"></a>
            <div class="comment odd" id="comment9">

                Works fine with Chrome 24, Ubuntu 12.10.

                <p class="comment-details">
                Posted by
                                    <b>Gary Gapinski</b>
                
                on November 09, 2012 at 12:46 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352465160000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352466924000" id="comment-1352466924000"></a>
            <div class="comment even" id="comment10">

                Now you just need to add a decent command-line to your demo (like https://github.com/mozilla/gcli) and you've got something wonderful!

                <p class="comment-details">
                Posted by
                                    <a rel="nofollow" href="http://astithas.com/"><b>Panos Astithas</b></a>
                
                on November 09, 2012 at 01:15 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352466924000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352580633000" id="comment-1352580633000"></a>
            <div class="comment odd" id="comment11">

                I'm really amazed of what you are doing, keep it up.

                <p class="comment-details">
                Posted by
                                    <b>Sci3ntist</b>
                
                on November 10, 2012 at 08:50 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352580633000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352636956000" id="comment-1352636956000"></a>
            <div class="comment even" id="comment12">

                As an educator, I can see a *lot* of utility in your approach.  Using this approach I can give students access to systems programming in the browser.

I was wondering if you would mind explaining a little more to those of us from a non-NetBSD background.  For example, I can see the code translated from C to JS, but I can't identify where the /ffs file system is.  Presumably, one needs to modify this file system image to provide a &quot;full&quot; shell such as bash or zsh?  Is there any way of installing ports on /ffs?

Coming from a Linux background, this project demonstrates some of the unique features of NetBSD very well.

                <p class="comment-details">
                Posted by
                                    <a rel="nofollow" href="http://www.phoric.eu/aidan"><b>Aidan Delaney</b></a>
                
                on November 11, 2012 at 12:29 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352636956000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352732717000" id="comment-1352732717000"></a>
            <div class="comment odd" id="comment13">

                Aidan: I agree that rump kernels have some good characteristics for systems education, both from the perspective of giving the student a low barrier of entry to real-world kernel code and from the perspective of the educator being able to verify the results of the exercise.  However, I am not sure why you consider the web browser a good environment for this.  Is there any specific reason, or, since you mention not being familiar with NetBSD, is this simply because you are unaware of the capability to host rump kernels in regular processes?  If you're interested in investigating further, I'd suggest starting by walking through this tutorial: http://www.netbsd.org/docs/rump/sptut.html

                <p class="comment-details">
                Posted by
                                    <b>Antti Kantee</b>
                
                on November 12, 2012 at 03:05 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352732717000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1352928298000" id="comment-1352928298000"></a>
            <div class="comment even" id="comment14">

                Using the web has several advantages, one  of which is that I can present shell scripting notes and an interpreter side-by-side.  There are other advantages such as zero-install.  I'm reading the rump kernel documentation.  I'm assuming that applications on top of the rump kernel need to treat JavaScript as their &quot;ISA&quot;. As in, I'd need to emscripten dash (or similar) to run on the rump kernel?

                <p class="comment-details">
                Posted by
                                    <b>Aidan Delaney</b>
                
                on November 14, 2012 at 09:24 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1352928298000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1353679496000" id="comment-1353679496000"></a>
            <div class="comment odd" id="comment15">

                A rump kernel is not a program execution environment.  It's more on the lines of &quot;kernel as a service&quot;.

Now, I don't think this is the best possible place to delve into details, so if you want to discuss this more, please contact me via email.

                <p class="comment-details">
                Posted by
                                    <b>Antti Kantee</b>
                
                on November 23, 2012 at 02:04 PM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1353679496000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                                <a name="comment-1356145696000" id="comment-1356145696000"></a>
            <div class="comment even" id="comment16">

                my mind has been blown

                <p class="comment-details">
                Posted by
                                    <a rel="nofollow" href="http://github.com/donbright"><b>don bright</b></a>
                
                on December 22, 2012 at 03:08 AM UTC

                <a href="http://blog.netbsd.org/tnf/entry/kernel_drivers_compiled_to_javascript#comment-1356145696000"
                   class="entrypermalink" title="comment permalink">#</a>
                </p>

            </div>

                </div>
		     		     
    <div class="comments-form">
    <div class="comments-head">Post a Comment:</div>
    <a name="comment-form"></a>

    <span class="status">Comments are closed for this entry.</span>

    </div>
		  				</div>
			</div>
			<div class="clearer"></div>
		</div>
		<div class="rowOfBoxes">
			<div id="footer">
				<span class="footfeed"><a href="http://www.NetBSD.org/cgi-bin/feedback.cgi">Contact</a> |</span> <span class="footcopy"><a href="http://www.NetBSD.org/about/disclaimer.html">Disclaimer</a> | <span class="copyright">Copyright © 1994-2009 The NetBSD Foundation, Inc.</span> ALL RIGHTS RESERVED.<br />
				NetBSD<sup>®</sup> is a registered trademark of The NetBSD Foundation, Inc.</span>
			</div>
		</div>
	</body>
</html>

